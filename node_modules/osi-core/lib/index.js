var fs = require('fs');
var appHome = "/home/lloyd/app/osi-server/node_modules/osi-core";
// Define the home route
var homeConfig = require('../cfg/home.json');
var homeconfig = {
    handler: function (request) {
        request.reply.view('home.html', homeConfig);
   }
};

// Define the admin route
var adminConfig = require('../cfg/admin/config.json');
var adminConfigconfig = {
    handler: function (request) {
        request.reply.view('admin/config.html', adminConfig);
   }
};

// Define the host route
var hostconfig = {
    handler: function (request) {
        if (request.payload) {
           //console.log(request.payload);
           if (request.payload.save) {
              var hostConfig = request.payload;
              var hostFile=appHome+"/user/host/"+hostConfig.hostname+"."+hostConfig.domainname+".json";
              fs.writeFileSync(hostFile,JSON.stringify(hostConfig,null,3));
              hostConfig.message="Successfully Saved.";
           }
        } else if (request.query.hostname && request.query.domainname) {
           // you manually sent a hostname query so check to see if there is a pprofile and fill it out
           var hostFile=appHome+"/user/host/"+request.query.hostname+"."+request.query.domainname+".json";
           var hostConfig = require(hostFile);
        } else {
           // set some defaults
           var hostConfig = require(appHome+"/cfg/host.json");
        }
        request.reply.view('host.html', hostConfig);
   }
};

var raweditconfig = {
    handler: function (request) {
        if (request.query.filename === "some.cfg") {
           //request.query.contents = "home contents";
           request.query.contents = fs.readFileSync("/home/lloyd/app/osi-server/node_modules/osi-core/user/"+request.query.filename);
        }
        if (request.save) {
           fs.writeFileSync("/home/lloyd/app/osi-server/node_modules/osi-core/user/"+request.query.contents);
           request.message="Successfully Saved.";
        } else {
           request.message="Not Saved.";
        }
        //console("save value:"+request.query.save);
        request.reply.view('rawedit.html', request.query);
   }
};

exports.register = function (plugin, options, next) {
    plugin.views({
        path: 'templates',
        engines: {
            html: 'handlebars'
        }
    });
    plugin.log(['osi-core', 'info'], 'Plugin registered');
    plugin.select('http').route({ method: '*', path: '/host', config: hostconfig });
    plugin.select('http').route({ method: 'GET', path: '/admin/config', config: adminConfigconfig });
    plugin.select('http').route({ method: '*', path: '/admin/rawedit', config: raweditconfig });
    plugin.select('http').route({ method: 'GET', path: '/', config: homeconfig });
    next();
};
